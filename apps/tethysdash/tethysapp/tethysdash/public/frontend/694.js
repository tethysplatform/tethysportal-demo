"use strict";(self.webpackChunktethysdash_frontend=self.webpackChunktethysdash_frontend||[]).push([[694],{22808:(e,t,r)=>{r.d(t,{A:()=>o});var n=r(60764),i=r(45360);class s extends n.A{constructor(e){e=e||{};const t=Object.assign({},e),r=e.cacheSize;delete e.cacheSize,delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=r,this.setPreload(void 0!==e.preload?e.preload:0),this.setUseInterimTilesOnError(void 0===e.useInterimTilesOnError||e.useInterimTilesOnError)}getCacheSize(){return this.cacheSize_}getPreload(){return this.get(i.A.PRELOAD)}setPreload(e){this.set(i.A.PRELOAD,e)}getUseInterimTilesOnError(){return this.get(i.A.USE_INTERIM_TILES_ON_ERROR)}setUseInterimTilesOnError(e){this.set(i.A.USE_INTERIM_TILES_ON_ERROR,e)}getData(e){return super.getData(e)}}const o=s},83954:(e,t,r)=>{function n(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function i(e,t){return e[0]=t[0],e[1]=t[1],e[4]=t[2],e[5]=t[3],e[12]=t[4],e[13]=t[5],e}function s(e,t,r,n,i,s,o){const a=1/(e-t),l=1/(r-n),h=1/(i-s);return(o=o??[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*h,o[11]=0,o[12]=(e+t)*a,o[13]=(n+r)*l,o[14]=(s+i)*h,o[15]=1,o}function o(e,t,r,n,i){return(i=i??[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*r,i[5]=e[5]*r,i[6]=e[6]*r,i[7]=e[7]*r,i[8]=e[8]*n,i[9]=e[9]*n,i[10]=e[10]*n,i[11]=e[11]*n,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function a(e,t,r,n,i){let s,o,a,l,h,u,c,f,d,_,g,T;return e===(i=i??[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])?(i[12]=e[0]*t+e[4]*r+e[8]*n+e[12],i[13]=e[1]*t+e[5]*r+e[9]*n+e[13],i[14]=e[2]*t+e[6]*r+e[10]*n+e[14],i[15]=e[3]*t+e[7]*r+e[11]*n+e[15]):(s=e[0],o=e[1],a=e[2],l=e[3],h=e[4],u=e[5],c=e[6],f=e[7],d=e[8],_=e[9],g=e[10],T=e[11],i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=h,i[5]=u,i[6]=c,i[7]=f,i[8]=d,i[9]=_,i[10]=g,i[11]=T,i[12]=s*t+h*r+d*n+e[12],i[13]=o*t+u*r+_*n+e[13],i[14]=a*t+c*r+g*n+e[14],i[15]=l*t+f*r+T*n+e[15]),i}function l(e,t,r,n){return(n=n??[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e,n[13]=t,n[14]=r,n[15]=1,n}r.d(t,{Tl:()=>a,Z1:()=>i,hs:()=>o,j0:()=>s,vt:()=>n,wT:()=>l})},94694:(e,t,r)=>{r.r(t),r.d(t,{default:()=>Ne});var n=r(49825),i=r(62446),s=r(11078),o=r(70915),a=r(36438),l=r(6782),h=r(9703),u=r(83954),c=r(90588),f=r(7771);const d=34962,_=34963,g=35044,T=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function m(e,t){t=Object.assign({preserveDrawingBuffer:!0,antialias:!f.oF},t);const r=T.length;for(let n=0;n<r;++n)try{const r=e.getContext(T[n],t);if(r)return r}catch{}return null}function p(e){switch(e){case d:return Float32Array;case _:return Uint32Array;default:return Float32Array}}const E=class{constructor(e,t){this.array_=null,this.type_=e,(0,c.v)(e===d||e===_,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=void 0!==t?t:35044}ofSize(e){return this.array_=new(p(this.type_))(e),this}fromArray(e){return this.array_=p(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(p(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=p(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}};var R=r(90025),x=r(43530),v=r(4087);const S="webglcontextlost",A="webglcontextrestored",b=class{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||"\n  precision mediump float;\n\n  attribute vec2 a_position;\n  varying vec2 v_texCoord;\n  varying vec2 v_screenCoord;\n\n  uniform vec2 u_screenSize;\n\n  void main() {\n    v_texCoord = a_position * 0.5 + 0.5;\n    v_screenCoord = v_texCoord * u_screenSize;\n    gl_Position = vec4(a_position, 0.0, 1.0);\n  }\n"),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||"\n  precision mediump float;\n\n  uniform sampler2D u_image;\n  uniform float u_opacity;\n\n  varying vec2 v_texCoord;\n\n  void main() {\n    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n  }\n"),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach((r=>{this.uniforms_.push({value:e.uniforms[r],location:t.getUniformLocation(this.renderTargetProgram_,r)})}))}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const e=0,n=t.RGBA,i=0,s=t.RGBA,o=t.UNSIGNED_BYTE,a=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,e,n,r[0],r[1],i,s,o,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const i=this.getGL(),s=e.size;if(i.bindFramebuffer(i.FRAMEBUFFER,t?t.getFrameBuffer():null),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.renderTargetTexture_),!t){const t=(0,v.v6)(i.canvas);if(!e.renderTargets[t]){const r=i.getContextAttributes();r&&r.preserveDrawingBuffer&&(i.clearColor(0,0,0,0),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)),e.renderTargets[t]=!0}}i.disable(i.DEPTH_TEST),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.viewport(0,0,i.drawingBufferWidth,i.drawingBufferHeight),i.bindBuffer(i.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),i.useProgram(this.renderTargetProgram_),i.enableVertexAttribArray(this.renderTargetAttribLocation_),i.vertexAttribPointer(this.renderTargetAttribLocation_,2,i.FLOAT,!1,0,0),i.uniform2f(this.renderTargetUniformLocation_,s[0],s[1]),i.uniform1i(this.renderTargetTextureLocation_,0);const o=e.layerStatesArray[e.layerIndex].opacity;i.uniform1f(this.renderTargetOpacityLocation_,o),this.applyUniforms(e),r&&r(i,e),i.drawArrays(i.TRIANGLES,0,6),n&&n(i,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach((function(i){if(r="function"==typeof i.value?i.value(e):i.value,r instanceof HTMLCanvasElement||r instanceof ImageData)i.texture||(i.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,i.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(i.location,n++);else if(Array.isArray(r))switch(r.length){case 2:return void t.uniform2f(i.location,r[0],r[1]);case 3:return void t.uniform3f(i.location,r[0],r[1],r[2]);case 4:return void t.uniform4f(i.location,r[0],r[1],r[2],r[3]);default:return}else"number"==typeof r&&t.uniform1f(i.location,r)}))}},y="u_pixelRatio",C={};function D(e){return"shared/"+e}let P=0;class L extends R.A{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?D(e.canvasCacheKey):function(){const e="unique/"+P;return P+=1,e}(),this.gl_=function(e){let t=C[e];if(!t){const r=document.createElement("canvas");r.width=1,r.height=1,r.style.position="absolute",r.style.left="0",t={users:0,context:m(r)},C[e]=t}return t.users+=1,t.context}(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(S,this.boundHandleWebGLContextLost_),t.addEventListener(A,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=(0,h.vt)(),this.offsetScaleMatrix_=(0,h.vt)(),this.tmpMat4_=(0,u.vt)(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map((e=>new b({webGlContext:this.gl_,scaleRatio:e.scaleRatio,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms}))):[new b({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===D(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=(0,v.v6)(e);let n=this.bufferCache_[r];n||(n={buffer:e,webGlBuffer:t.createBuffer()},this.bufferCache_[r]=n),t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=(0,v.v6)(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(S,this.boundHandleWebGLContextLost_),e.removeEventListener(A,this.boundHandleWebGLContextRestored_),function(e){const t=C[e];if(!t)return;if(t.users-=1,t.users>0)return;const r=t.context,n=r.getExtension("WEBGL_lose_context");n&&n.loseContext();const i=r.canvas;i.width=1,i.height=1,delete C[e]}(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,i=this.getCanvas(),s=e.size,o=e.pixelRatio;i.width===s[0]*o&&i.height===s[1]*o||(i.width=s[0]*o,i.height=s[1]*o,i.style.width=s[0]+"px",i.style.height=s[1]+"px");for(let t=this.postProcessPasses_.length-1;t>=0;t--)this.postProcessPasses_[t].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const n=this.getGL();this.bindBuffer(e);const i=this.getAttributeLocation(t);n.enableVertexAttribArray(i),n.vertexAttribPointer(i,r,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,n){const i=this.gl_,s=t.getSize();i.bindFramebuffer(i.FRAMEBUFFER,t.getFramebuffer()),i.bindRenderbuffer(i.RENDERBUFFER,t.getDepthbuffer()),i.viewport(0,0,s[0],s[1]),i.bindTexture(i.TEXTURE_2D,t.getTexture()),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,r?i.ZERO:i.ONE_MINUS_SRC_ALPHA),n?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,i=t-e,s=4*e;r.drawElements(r.TRIANGLES,i,n,s)}finalizeDraw(e,t,r){for(let n=0,i=this.postProcessPasses_.length;n<i;n++)n===i-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue("u_time",.001*(Date.now()-this.startTime_)),this.setUniformFloatValue("u_zoom",e.viewState.zoom),this.setUniformFloatValue("u_resolution",e.viewState.resolution),this.setUniformFloatValue(y,n),this.setUniformFloatVec2("u_viewportSizePx",[t[0],t[1]]),this.setUniformFloatValue("u_rotation",r)}applyHitDetectionUniform(e){const t=this.getUniformLocation("u_hitDetection");this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(y,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach((i=>{if(r="function"==typeof i.value?i.value(e):i.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!i.texture?(i.prevValue=void 0,i.texture=r):i.texture||(i.prevValue=void 0,i.texture=t.createTexture()),this.bindTexture(i.texture,n,i.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const e=!(r instanceof HTMLImageElement)||r.complete;r instanceof WebGLTexture||!e||i.prevValue===r||(i.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++}else if(Array.isArray(r)&&6===r.length)this.setUniformMatrixValue(i.name,(0,u.Z1)(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:return void t.uniform2f(this.getUniformLocation(i.name),r[0],r[1]);case 3:return void t.uniform3f(this.getUniformLocation(i.name),r[0],r[1],r[2]);case 4:return void t.uniform4f(this.getUniformLocation(i.name),r[0],r[1],r[2],r[3]);default:return}else"number"==typeof r&&t.uniform1f(this.getUniformLocation(i.name),r)}))}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),i=this.compileShader(t,r.VERTEX_SHADER),s=r.createProgram();if(r.attachShader(s,n),r.attachShader(s,i),r.linkProgram(s),!r.getShaderParameter(n,r.COMPILE_STATUS)){const e=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(e)}if(r.deleteShader(n),!r.getShaderParameter(i,r.COMPILE_STATUS)){const e=`Vertex shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(e)}if(r.deleteShader(i),!r.getProgramParameter(s,r.LINK_STATUS)){const e=`GL program linking failed: ${r.getProgramInfoLog(s)}`;throw new Error(e)}return s}getUniformLocation(e){const t=(0,v.v6)(this.currentProgram_);return void 0===this.uniformLocationsByProgram_[t]&&(this.uniformLocationsByProgram_[t]={}),void 0===this.uniformLocationsByProgram_[t][e]&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=(0,v.v6)(this.currentProgram_);return void 0===this.attribLocationsByProgram_[t]&&(this.attribLocationsByProgram_[t]={}),void 0===this.attribLocationsByProgram_[t][e]&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,i=e.viewState.resolution,s=e.viewState.center;return(0,h.Zz)(t,0,0,2/(i*r[0]),2/(i*r[1]),-n,-s[0],-s[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,n,i){const s=this.getAttributeLocation(e);s<0||(this.gl_.enableVertexAttribArray(s),this.gl_.vertexAttribPointer(s,t,r,!1,n,i))}enableAttributes(e){const t=function(e){let t=0;for(let r=0;r<e.length;r++){const n=e[r];t+=n.size*U(n.type)}return t}(e);let r=0;for(let n=0;n<e.length;n++){const i=e[n];this.enableAttributeArray_(i.name,i.size,i.type||5126,t,r),r+=i.size*U(i.type)}}handleWebGLContextLost(e){(0,x.I)(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,n){const i=this.gl_;r=r||i.createTexture();const s=n?i.NEAREST:i.LINEAR;i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);const o=i.RGBA,a=i.RGBA,l=i.UNSIGNED_BYTE;return t instanceof Uint8Array?i.texImage2D(i.TEXTURE_2D,0,o,e[0],e[1],0,a,l,t):t?i.texImage2D(i.TEXTURE_2D,0,o,a,l,t):i.texImage2D(i.TEXTURE_2D,0,o,e[0],e[1],0,a,l,null),r}}function U(e){switch(e){case 5121:return Uint8Array.BYTES_PER_ELEMENT;case 5123:return Uint16Array.BYTES_PER_ELEMENT;case 5125:return Uint32Array.BYTES_PER_ELEMENT;default:return Float32Array.BYTES_PER_ELEMENT}}const F=L;var $=r(27607),w=r(40190),B=r(68711),I=r(97404),M=r(6837),N=r(79332);class G extends N.A{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(M.A.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===s.A.LOADED,this.loaded)this.uploadTile();else{if(e instanceof w.A){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(M.A.CHANGE,this.handleTileChange_)}}uploadTile(){(0,v.b0)()}setReady(){this.ready=!0,this.dispatchEvent(M.A.CHANGE)}handleTileChange_(){this.tile.getState()===s.A.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(M.A.CHANGE,this.handleTileChange_)}}const O=G;function X(e,t,r){const n=r?e.LINEAR:e.NEAREST;e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n)}function Z(e,t,r,n,i,s){const o=e.getGL();let a,l;r instanceof Float32Array?(a=o.FLOAT,e.getExtension("OES_texture_float"),l=null!==e.getExtension("OES_texture_float_linear")):(a=o.UNSIGNED_BYTE,l=!0),X(o,t,s&&l);const h=r.byteLength/n[1];let u,c=1;switch(h%8==0?c=8:h%4==0?c=4:h%2==0&&(c=2),i){case 1:u=o.LUMINANCE;break;case 2:u=o.LUMINANCE_ALPHA;break;case 3:u=o.RGB;break;case 4:u=o.RGBA;break;default:throw new Error(`Unsupported number of bands: ${i}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,c),o.texImage2D(o.TEXTURE_2D,0,u,n[0],n[1],0,u,a,r),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let z=null;const H=class extends O{constructor(e){super(e),this.textures=[],this.renderSize_=(0,l.xq)(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new E(d,g);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){const t=this.helper?.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let e=0;e<this.textures.length;++e)t.deleteTexture(this.textures[e])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;let n;this.textures.length=0,n=r instanceof w.A||r instanceof I.A?r.getImage():r.getData();const i=(0,$.xo)(n);if(i){const e=t.createTexture();return this.textures.push(e),this.bandCount=4,function(e,t,r,n){X(e,t,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}(t,e,i,r.interpolate),void this.setReady()}n=(0,$.bL)(n);const s=r.getSize(),o=[s[0]+2*this.gutter,s[1]+2*this.gutter],a=n instanceof Float32Array,l=o[0]*o[1],h=a?Float32Array:Uint8Array,u=h.BYTES_PER_ELEMENT,c=n.byteLength/o[1];this.bandCount=Math.floor(c/u/o[0]);const f=Math.ceil(this.bandCount/4);if(1===f){const i=t.createTexture();return this.textures.push(i),Z(e,i,n,o,this.bandCount,r.interpolate),void this.setReady()}const d=new Array(f);for(let e=0;e<f;++e){const r=t.createTexture();this.textures.push(r);const n=e<f-1?4:(this.bandCount-1)%4+1;d[e]=new h(l*n)}let _=0,g=0;const T=o[0]*this.bandCount;for(let e=0;e<o[1];++e){for(let e=0;e<T;++e){const t=n[g+e],r=Math.floor(_/this.bandCount),i=e%this.bandCount,s=d[Math.floor(i/4)];s[r*(s.length/l)+i%4]=t,++_}g+=c/u}for(let t=0;t<f;++t){const n=this.textures[t],i=d[t];Z(e,n,i,o,i.length/l,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const n=this.gutter,i=this.renderSize_[0],s=this.renderSize_[1];z||(z=(0,B.Y)(1,1,void 0,{willReadFrequently:!0})),z.clearRect(0,0,1,1);const o=e.width-2*n,a=e.height-2*n,l=n+Math.floor(o*(t/i)),h=n+Math.floor(a*(r/s));let u;try{z.drawImage(e,l,h,1,1,0,0,1,1),u=z.getImageData(0,0,1,1).data}catch{return z=null,null}return u}getArrayPixelData_(e,t,r,n){const i=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1],a=t[0],l=t[1],h=a+2*i,u=l+2*i,c=i+Math.floor(a*(r/s)),f=i+Math.floor(l*(n/o));if(e instanceof DataView){const t=e.byteLength/(h*u),r=t*(f*h+c),n=e.buffer.slice(r,r+t);return new DataView(n)}const d=this.bandCount*(f*h+c);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof $.Ay){const r=this.tile.getData(),n=(0,$.bL)(r);if(n){const r=this.tile.getSize();return this.getArrayPixelData_(n,r,e,t)}return this.getImagePixelData_((0,$.xo)(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}};var j=r(91110),V=r(66514),W=r(14969),Y=r(40186),k=r(75332),q=r(9960),K=r(83984),Q=r(5986);class J extends Q.A{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=(0,h.vt)(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(k.A.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(K.A.PRECOMPOSE)){const n=new q.A(K.A.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(K.A.POSTCOMPOSE)){const n=new q.A(K.A.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t,r=!0,n=-1;for(let i=0,s=e.layerStatesArray.length;i<s;i++){const s=e.layerStatesArray[i].layer,o=s.getRenderer();if(!(o instanceof J)){r=!0;continue}const a=s.getClassName();if((r||a!==t)&&(n+=1,r=!1),t=a,o===this)break}const i="map/"+e.mapId+"/group/"+n;this.helper&&this.helper.canvasCacheKeyMatches(i)&&!this.helper.needsToBeRecreated()||(this.removeHelper(),this.helper=new F({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:i}),t&&(this.helper.getCanvas().className=t),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){this.clearCache(),this.removeHelper(),this.getLayer()?.removeChangeListener(k.A.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){(0,h.Zz)(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const i=new q.A(e,this.inversePixelTransform_,r,t);n.dispatchEvent(i)}}preRender(e,t){this.dispatchRenderEvent_(K.A.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(K.A.POSTRENDER,e,t)}}const ee=J;function te(e){return 1/(e+2)}function re(e,t){return e.tileIds.has((0,v.v6)(t))}function ne(e,t,r){const n=e.representationsByZ;r in n||(n[r]=new Set),n[r].add(t),e.tileIds.add((0,v.v6)(t.tile))}function ie(e,t){const r=e.layerStatesArray[e.layerIndex];r.extent&&(t=(0,o._N)(t,(0,a.SD)(r.extent,e.viewState.projection)));const n=r.layer.getRenderSource();if(!n.getWrapX()){const r=n.getTileGridForProjection(e.viewState.projection).getExtent();r&&(t=(0,o._N)(t,r))}return t}function se(e,t){return`${e.getKey()},${e.getRevision()},${(0,Y.i7)(t)}`}const oe=class extends ee{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=(0,h.vt)(),this.tempMat4=(0,u.vt)(),this.tempTileRange_=new j.A(0,0,0,0),this.tempTileCoord_=(0,Y.N)(0,0,0),this.tempSize_=[0,0];const r=void 0!==t.cacheSize?t.cacheSize:512;this.tileRepresentationCache=new W.A(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const t=this.getLayer().getRenderSource();return!!t&&!(0,o.Im)(ie(e,e.extent))&&"ready"===t.getState()}createTileRepresentation(e){return(0,v.b0)()}enqueueTiles(e,t,r,n,i){const a=e.viewState,l=this.getLayer(),h=l.getRenderSource(),u=h.getTileGridForProjection(a.projection),c=h.getGutterForProjection(a.projection),f=(0,v.v6)(h);f in e.wantedTiles||(e.wantedTiles[f]={});const d=e.wantedTiles[f],_=this.tileRepresentationCache,g=l.getMapInternal(),T=Math.max(r-i,u.getMinZoom(),u.getZForResolution(Math.min(l.getMaxResolution(),g?g.getView().getResolutionForZoom(Math.max(l.getMinZoom(),0)):u.getResolution(0)),h.zDirection)),m=a.rotation,p=m?(0,o.Yw)(a.center,a.resolution,m,e.size):void 0;for(let i=r;i>=T;--i){const r=u.getTileRangeForExtentAndZ(t,i,this.tempTileRange_),o=u.getResolution(i);for(let t=r.minX;t<=r.maxX;++t)for(let l=r.minY;l<=r.maxY;++l){if(m&&!u.tileCoordIntersectsViewport([i,t,l],p))continue;const r=(0,Y.N)(i,t,l,this.tempTileCoord_),g=se(h,r);let T,E;if(_.containsKey(g)&&(T=_.get(g),E=T.tile),!(T&&T.tile.key===h.getKey()||(E=h.getTile(i,t,l,e.pixelRatio,a.projection),E)))continue;if(re(n,E))continue;T?T.setTile(E):(T=this.createTileRepresentation({tile:E,grid:u,helper:this.helper,gutter:c}),_.set(g,T)),ne(n,T,i);const R=E.getKey();d[R]=!0,E.getState()===s.A.IDLE&&(e.tileQueue.isKeyQueued(R)||e.tileQueue.enqueue([E,f,u.getTileCoordCenter(r),o]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,n,i,s,o,a,l,h,u){}renderTileMask(e,t,r,n){}drawTile_(e,t,r,n,i,s,o){if(!t.ready)return;const a=t.tile.tileCoord,u=(0,Y.i7)(a),c=u in s?s[u]:1,f=o.getResolution(r),d=(0,l.xq)(o.getTileSize(r),this.tempSize_),_=o.getOrigin(r),g=o.getTileCoordExtent(a),T=c<1?-1:te(r);c<1&&(e.animate=!0);const m=e.viewState,p=m.center[0],E=m.center[1],R=d[0]+2*n,x=d[1]+2*n,v=R/x,S=(p-_[0])/(d[0]*f),A=(_[1]-E)/(d[1]*f),b=m.resolution/f,y=a[1],C=a[2];(0,h.cL)(this.tileTransform_),(0,h.hs)(this.tileTransform_,2/(e.size[0]*b/R),-2/(e.size[1]*b/R)),(0,h.e$)(this.tileTransform_,m.rotation),(0,h.hs)(this.tileTransform_,1,1/v),(0,h.Tl)(this.tileTransform_,(d[0]*(y-S)-n)/R,(d[1]*(C-A)-n)/x),this.renderTile(t,this.tileTransform_,e,i,f,d,_,g,T,n,c)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),i=n.getRenderSource(),o=i.getTileGridForProjection(r.projection),a=i.getGutterForProjection(r.projection),l=ie(e,e.extent),h=o.getZForResolution(r.resolution,i.zDirection),u={tileIds:new Set,representationsByZ:{}},c=n.getPreload();if(e.nextExtent){const t=o.getZForResolution(r.nextResolution,i.zDirection),n=ie(e,e.nextExtent);this.enqueueTiles(e,n,t,u,c)}this.enqueueTiles(e,l,h,u,0),c>0&&setTimeout((()=>{this.enqueueTiles(e,l,h-1,u,c-1)}),0);const f={};let d=!1;const _=u.representationsByZ;if(h in _){const t=(0,v.v6)(this),r=e.time;for(const e of _[h]){const n=e.tile;if(n.getState()===s.A.EMPTY)continue;const i=n.tileCoord;if(e.ready){const e=n.getAlpha(t,r);if(1===e){n.endTransition(t);continue}d=!0,f[(0,Y.i7)(i)]=e}if(this.renderComplete=!1,this.findAltTiles_(o,i,h+1,u))continue;const a=o.getMinZoom();for(let e=h-1;e>=a&&!this.findAltTiles_(o,i,e,u);--e);}}const g=Object.keys(_).map(Number).sort(V.rG);if(this.beforeTilesMaskRender(e))for(let e=0,t=g.length;e<t;++e){const t=g[e];for(const e of _[t]){const r=e.tile.tileCoord;if((0,Y.i7)(r)in f)continue;const n=o.getTileCoordExtent(r);this.renderTileMask(e,t,n,te(t))}}this.beforeTilesRender(e,d);for(let t=0,r=g.length;t<r;++t){const r=g[t];for(const t of _[r]){const n=t.tile.tileCoord;(0,Y.i7)(n)in f||this.drawTile_(e,t,r,a,l,f,o)}}if(h in _)for(const t of _[h]){const r=t.tile.tileCoord;(0,Y.i7)(r)in f&&this.drawTile_(e,t,h,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const T=this.helper.getCanvas(),m=this.tileRepresentationCache;for(;m.canExpireCache();)m.pop().dispose();return this.postRender(t,e),T}beforeFinalize(e){}findAltTiles_(e,t,r,n){const i=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!i)return!1;let s=!0;const o=this.tileRepresentationCache,a=this.getLayer().getRenderSource();for(let e=i.minX;e<=i.maxX;++e)for(let t=i.minY;t<=i.maxY;++t){const i=se(a,[r,e,t]);let l=!1;if(o.containsKey(i)){const e=o.get(i);e.ready&&!re(n,e.tile)&&(ne(n,e,r),l=!0)}l||(s=!1)}return s}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach((e=>e.dispose())),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach((e=>e.setHelper(this.helper)))}disposeInternal(){super.disposeInternal(),delete this.frameState}},ae="u_tileTransform",le="u_transitionAlpha",he="u_depth",ue="u_renderExtent",ce="u_resolution",fe="u_zoom",de="u_tileTextures",_e="u_texturePixelWidth",ge="u_texturePixelHeight",Te="u_textureResolution",me="u_textureOriginX",pe="u_textureOriginY",Ee="a_textureCoord",Re=[{name:Ee,size:2,type:5126}],xe=class extends oe{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new E(_,g),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new H(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,i,s,a,l,h,c,f){const d=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Re);let _=0;for(;_<e.textures.length;){const t=`${de}[${_}]`;this.helper.bindTexture(e.textures[_],_,t),++_}for(let e=0;e<this.paletteTextures_.length;++e){const t=this.paletteTextures_[e],r=t.getTexture(d);this.helper.bindTexture(r,_,t.name),++_}const g=r.viewState,T=s[0]+2*c,m=s[1]+2*c,p=e.tile.tileCoord,E=p[1],R=p[2];this.helper.setUniformMatrixValue(ae,(0,u.Z1)(this.tempMat4,t)),this.helper.setUniformFloatValue(le,f),this.helper.setUniformFloatValue(he,h);let x=n;c>0&&(x=l,(0,o._N)(x,n,x)),this.helper.setUniformFloatVec4(ue,x),this.helper.setUniformFloatValue(ce,g.resolution),this.helper.setUniformFloatValue(fe,g.zoom),this.helper.setUniformFloatValue(_e,T),this.helper.setUniformFloatValue(ge,m),this.helper.setUniformFloatValue(Te,i),this.helper.setUniformFloatValue(me,a[0]+E*s[0]*i-c*i),this.helper.setUniformFloatValue(pe,a[1]-R*s[1]*i+c*i),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const t=this.frameState;if(!t)return null;const r=this.getLayer(),n=(0,h.Bb)(t.pixelToCoordinateTransform,e.slice()),i=t.viewState,u=r.getExtent();if(u&&!(0,o.Ym)((0,a.SD)(u,i.projection),n))return null;const c=r.getSources((0,o.Tr)([n]),i.resolution);let f,d,_;for(f=c.length-1;f>=0;--f)if(d=c[f],"ready"===d.getState()){if(_=d.getTileGridForProjection(i.projection),d.getWrapX())break;const e=_.getExtent();if(!e||(0,o.Ym)(e,n))break}if(f<0)return null;const g=this.tileRepresentationCache;for(let e=_.getZForResolution(i.resolution);e>=_.getMinZoom();--e){const t=_.getTileCoordForCoordAndZ(n,e),r=se(d,t);if(!g.containsKey(r))continue;const i=g.get(r);if(i.tile.getState()===s.A.EMPTY)return null;if(!i.loaded)continue;const o=_.getOrigin(e),a=(0,l.xq)(_.getTileSize(e)),h=_.getResolution(e),u=(n[0]-o[0])/h-t[1]*a[0],c=(o[1]-n[1])/h-t[2]*a[1];return i.getPixelData(u,c)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const e of this.paletteTextures_)e.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}},ve=class{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}};function Se(e){const t=e.toString();return t.includes(".")?t:t+".0"}function Ae(e){if(e.length<2||e.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${e.length}(${e.map(Se).join(", ")})`}const be={};let ye=0;function Ce(e){return e in be||(be[e]=ye++),be[e]}function De(e){return"u_var_"+e}const Pe="getBandValue",Le="u_paletteTextures";function Ue(e){return(t,r,n)=>{const i=r.args.length,s=new Array(i);for(let e=0;e<i;++e)s[e]=$e(r.args[e],n,t);return e(s,t)}}const Fe={[n.ZD.Get]:(e,t)=>{const r=t.args[0].value;return r in e.properties||(e.properties[r]={name:r,type:t.type}),(e.inFragmentShader?"v_prop_":"a_prop_")+r},[n.ZD.Id]:e=>(e.featureId=!0,(e.inFragmentShader?"v_":"a_")+"featureId"),[n.ZD.GeometryType]:e=>(e.geometryType=!0,(e.inFragmentShader?"v_":"a_")+"geometryType"),[n.ZD.LineMetric]:()=>"currentLineMetric",[n.ZD.Var]:(e,t)=>{const r=t.args[0].value;return r in e.variables||(e.variables[r]={name:r,type:t.type}),De(r)},[n.ZD.Resolution]:()=>"u_resolution",[n.ZD.Zoom]:()=>"u_zoom",[n.ZD.Time]:()=>"u_time",[n.ZD.Any]:Ue((e=>`(${e.join(" || ")})`)),[n.ZD.All]:Ue((e=>`(${e.join(" && ")})`)),[n.ZD.Not]:Ue((([e])=>`(!${e})`)),[n.ZD.Equal]:Ue((([e,t])=>`(${e} == ${t})`)),[n.ZD.NotEqual]:Ue((([e,t])=>`(${e} != ${t})`)),[n.ZD.GreaterThan]:Ue((([e,t])=>`(${e} > ${t})`)),[n.ZD.GreaterThanOrEqualTo]:Ue((([e,t])=>`(${e} >= ${t})`)),[n.ZD.LessThan]:Ue((([e,t])=>`(${e} < ${t})`)),[n.ZD.LessThanOrEqualTo]:Ue((([e,t])=>`(${e} <= ${t})`)),[n.ZD.Multiply]:Ue((e=>`(${e.join(" * ")})`)),[n.ZD.Divide]:Ue((([e,t])=>`(${e} / ${t})`)),[n.ZD.Add]:Ue((e=>`(${e.join(" + ")})`)),[n.ZD.Subtract]:Ue((([e,t])=>`(${e} - ${t})`)),[n.ZD.Clamp]:Ue((([e,t,r])=>`clamp(${e}, ${t}, ${r})`)),[n.ZD.Mod]:Ue((([e,t])=>`mod(${e}, ${t})`)),[n.ZD.Pow]:Ue((([e,t])=>`pow(${e}, ${t})`)),[n.ZD.Abs]:Ue((([e])=>`abs(${e})`)),[n.ZD.Floor]:Ue((([e])=>`floor(${e})`)),[n.ZD.Ceil]:Ue((([e])=>`ceil(${e})`)),[n.ZD.Round]:Ue((([e])=>`floor(${e} + 0.5)`)),[n.ZD.Sin]:Ue((([e])=>`sin(${e})`)),[n.ZD.Cos]:Ue((([e])=>`cos(${e})`)),[n.ZD.Atan]:Ue((([e,t])=>void 0!==t?`atan(${e}, ${t})`:`atan(${e})`)),[n.ZD.Sqrt]:Ue((([e])=>`sqrt(${e})`)),[n.ZD.Match]:Ue((e=>{const t=e[0],r=e[e.length-1];let n=null;for(let i=e.length-3;i>=1;i-=2)n=`(${t} == ${e[i]} ? ${e[i+1]} : ${n||r})`;return n})),[n.ZD.Between]:Ue((([e,t,r])=>`(${e} >= ${t} && ${e} <= ${r})`)),[n.ZD.Interpolate]:Ue((([e,t,...r])=>{let n="";for(let i=0;i<r.length-2;i+=2){const s=r[i],o=n||r[i+1],a=r[i+2],l=r[i+3];let h;h=e===Se(1)?`(${t} - ${s}) / (${a} - ${s})`:`(pow(${e}, (${t} - ${s})) - 1.0) / (pow(${e}, (${a} - ${s})) - 1.0)`,n=`mix(${o}, ${l}, clamp(${h}, 0.0, 1.0))`}return n})),[n.ZD.Case]:Ue((e=>{const t=e[e.length-1];let r=null;for(let n=e.length-3;n>=0;n-=2)r=`(${e[n]} ? ${e[n+1]} : ${r||t})`;return r})),[n.ZD.In]:Ue((([e,...t],r)=>{const n=function(e,t){return`operator_in_${Object.keys(t.functions).length}`}(0,r),i=[];for(let e=0;e<t.length;e+=1)i.push(`  if (inputValue == ${t[e]}) { return true; }`);return r.functions[n]=`bool ${n}(float inputValue) {\n${i.join("\n")}\n  return false;\n}`,`${n}(${e})`})),[n.ZD.Array]:Ue((e=>`vec${e.length}(${e.join(", ")})`)),[n.ZD.Color]:Ue((e=>{if(1===e.length)return`vec4(vec3(${e[0]} / 255.0), 1.0)`;if(2===e.length)return`vec4(vec3(${e[0]} / 255.0), ${e[1]})`;const t=e.slice(0,3).map((e=>`${e} / 255.0`));if(3===e.length)return`vec4(${t.join(", ")}, 1.0)`;const r=e[3];return`vec4(${t.join(", ")}, ${r})`})),[n.ZD.Band]:Ue((([e,t,r],n)=>{if(!(Pe in n.functions)){let e="";const t=n.bandCount||1;for(let r=0;r<t;r++){const n=Math.floor(r/4);let i=r%4;r===t-1&&1===i&&(i=3),e+=`  if (band == ${r+1}.0) {\n    return texture2D(${de}[${n}], v_textureCoord + vec2(dx, dy))[${i}];\n  }\n`}n.functions[Pe]=`float getBandValue(float band, float xOffset, float yOffset) {\n  float dx = xOffset / ${_e};\n  float dy = yOffset / ${ge};\n${e}\n}`}return`${Pe}(${e}, ${t??"0.0"}, ${r??"0.0"})`})),[n.ZD.Palette]:(e,t)=>{const[r,...s]=t.args,o=s.length,a=new Uint8Array(4*o);for(let e=0;e<s.length;e++){const t=s[e].value,r=(0,i._j)(t),n=4*e;a[n]=r[0],a[n+1]=r[1],a[n+2]=r[2],a[n+3]=255*r[3]}e.paletteTextures||(e.paletteTextures=[]);const l=`${Le}[${e.paletteTextures.length}]`,h=new ve(l,a);return e.paletteTextures.push(h),`texture2D(${l}, vec2((${$e(r,n.wl,e)} + 0.5) / ${o}.0, 0.5))`}};function $e(e,t,r){if(e instanceof n.DG){const n=Fe[e.operator];if(void 0===n)throw new Error(`No compiler defined for this operator: ${JSON.stringify(e.operator)}`);return n(r,e,t)}if((e.type&n.wl)>0)return Se(e.value);if((e.type&n.T8)>0)return e.value.toString();if((e.type&n.cT)>0)return Se(Ce(e.value.toString()));var s;if((e.type&n.mE)>0)return function(e){const t=(0,i._j)(e),r=t.length>3?t[3]:1;return Ae([t[0]/255,t[1]/255,t[2]/255,r])}(e.value);if((e.type&n.Fq)>0)return Ae(e.value);if((e.type&n.qA)>0)return s=e.value,Ae((0,l.xq)(s));throw new Error(`Unexpected expression ${e.value} (expected type ${(0,n.go)(t)})`)}function we(e,t,r){return function(e,t,r,i){return $e((0,n.qg)(e,t,r),t,i)}(t,r,(0,n.SR)(),e)}var Be=r(22808);function Ie(e,t){const r=`\n    attribute vec2 ${Ee};\n    uniform mat4 ${ae};\n    uniform float ${_e};\n    uniform float ${ge};\n    uniform float ${Te};\n    uniform float ${me};\n    uniform float ${pe};\n    uniform float ${he};\n\n    varying vec2 v_textureCoord;\n    varying vec2 v_mapCoord;\n\n    void main() {\n      v_textureCoord = ${Ee};\n      v_mapCoord = vec2(\n        ${me} + ${Te} * ${_e} * v_textureCoord[0],\n        ${pe} - ${Te} * ${ge} * v_textureCoord[1]\n      );\n      gl_Position = ${ae} * vec4(${Ee}, ${he}, 1.0);\n    }\n  `,i={inFragmentShader:!1,variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1,inFragmentShader:!0,bandCount:t},s=[];if(void 0!==e.color){const t=we(i,e.color,n.mE);s.push(`color = ${t};`)}if(void 0!==e.contrast){const t=we(i,e.contrast,n.wl);s.push(`color.rgb = clamp((${t} + 1.0) * color.rgb - (${t} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(void 0!==e.exposure){const t=we(i,e.exposure,n.wl);s.push(`color.rgb = clamp((${t} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(void 0!==e.saturation){const t=we(i,e.saturation,n.wl);s.push(`\n      float saturation = ${t} + 1.0;\n      float sr = (1.0 - saturation) * 0.2126;\n      float sg = (1.0 - saturation) * 0.7152;\n      float sb = (1.0 - saturation) * 0.0722;\n      mat3 saturationMatrix = mat3(\n        sr + saturation, sr, sr,\n        sg, sg + saturation, sg,\n        sb, sb, sb + saturation\n      );\n      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));\n    `)}if(void 0!==e.gamma){const t=we(i,e.gamma,n.wl);s.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${t}));`)}if(void 0!==e.brightness){const t=we(i,e.brightness,n.wl);s.push(`color.rgb = clamp(color.rgb + ${t}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const o={},a=Object.keys(i.variables).length;if(a>1&&!e.variables)throw new Error(`Missing variables in style (expected ${i.variables})`);for(let t=0;t<a;++t){const r=i.variables[Object.keys(i.variables)[t]];if(!(r.name in e.variables))throw new Error(`Missing '${r.name}' in style variables`);o[De(r.name)]=function(){let t=e.variables[r.name];return"string"==typeof t&&(t=Ce(t)),void 0!==t?t:-9999999}}const l=Object.keys(o).map((function(e){return`uniform float ${e};`})),h=Math.ceil(t/4);l.push(`uniform sampler2D ${de}[${h}];`),i.paletteTextures&&l.push(`uniform sampler2D ${Le}[${i.paletteTextures.length}];`);const u=Object.keys(i.functions).map((function(e){return i.functions[e]}));return{vertexShader:r,fragmentShader:`\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n    precision highp float;\n    #else\n    precision mediump float;\n    #endif\n\n    varying vec2 v_textureCoord;\n    varying vec2 v_mapCoord;\n    uniform vec4 ${ue};\n    uniform float ${le};\n    uniform float ${_e};\n    uniform float ${ge};\n    uniform float ${ce};\n    uniform float ${fe};\n\n    ${l.join("\n")}\n\n    ${u.join("\n")}\n\n    void main() {\n      if (\n        v_mapCoord[0] < ${ue}[0] ||\n        v_mapCoord[1] < ${ue}[1] ||\n        v_mapCoord[0] > ${ue}[2] ||\n        v_mapCoord[1] > ${ue}[3]\n      ) {\n        discard;\n      }\n\n      vec4 color = texture2D(${de}[0],  v_textureCoord);\n\n      ${s.join("\n")}\n\n      gl_FragColor = color;\n      gl_FragColor.rgb *= gl_FragColor.a;\n      gl_FragColor *= ${le};\n    }`,uniforms:o,paletteTextures:i.paletteTextures}}class Me extends Be.A{constructor(e){const t=(e=e?Object.assign({},e):{}).style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(k.A.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?"function"==typeof this.sources_?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if("loading"===e.getState()){const t=()=>{"ready"===e.getState()&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Ie(this.style_,this.getSourceBandCount_());return new xe(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let i=0,s=t.length;i<s;++i)this.renderedSource_=t[i],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let i=!0;for(let e=0,t=n.length;e<t;++e){const t=n[e],r=t.getState();if("loading"==r){const e=()=>{"ready"==t.getState()&&(t.removeEventListener("change",e),this.changed())};t.addEventListener("change",e)}i=i&&"ready"==r}const s=this.renderSources(e,n);if(this.getRenderer().renderComplete&&i)return this.renderedResolution_=r.resolution,s;if(this.renderedResolution_>.5*r.resolution){const t=this.getSources(e.extent,this.renderedResolution_).filter((e=>!n.includes(e)));if(t.length>0)return this.renderSources(e,t)}return s}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const e=Ie(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,paletteTextures:e.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Me.prototype.dispose;const Ne=Me}}]);